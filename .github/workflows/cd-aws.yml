name: CD - AWS (Terraform + ECR)

on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]
    workflow_dispatch: {} # para correr apply manual

env:
    AWS_REGION: us-east-1
    PROJECT_NAME: aiops-tfm
    OWNER: kevin
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

jobs:
    lint-and-test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                service: [detector, predictor, rca, simulator]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install dependencies
              run: |
                  cd services/${{ matrix.service }}
                  pip install -r requirements.txt
                  pip install flake8 pytest

            - name: Run linter
              run: |
                  cd services/${{ matrix.service }}
                  flake8 .

            - name: Run tests
              env:
                  PYTHONPATH: services/${{ matrix.service }}
              run: |
                  pytest services/${{ matrix.service }}/tests -v

    terraform-plan:
        runs-on: ubuntu-latest
        needs: lint-and-test

        steps:
            - uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
                  aws-session-token: ${{ env.AWS_SESSION_TOKEN }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3

            - name: Terraform Init
              working-directory: infrastructure/terraform
              run: terraform init

            - name: Terraform Validate
              working-directory: infrastructure/terraform
              run: terraform validate

            - name: Terraform Plan
              working-directory: infrastructure/terraform
              run: terraform plan -out=tfplan

            - name: Upload tfplan
              uses: actions/upload-artifact@v4
              with:
                  name: tfplan
                  path: infrastructure/terraform/tfplan

    push-ecr:
        runs-on: ubuntu-latest
        needs: terraform-plan
        if: github.event_name == 'push' # push a master publica imagenes

        steps:
            - uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
                  aws-session-token: ${{ env.AWS_SESSION_TOKEN }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to ECR
              uses: aws-actions/amazon-ecr-login@v2

            - name: Build & Push images to ECR
              env:
                  ACCOUNT_ID: ${{ secrets.ECR_ACCOUNT_ID }}
                  REGION: ${{ env.AWS_REGION }}
                  PROJECT_NAME: ${{ env.PROJECT_NAME }}
                  OWNER: ${{ env.OWNER }}
              run: |
                  set -e
                  PREFIX="$PROJECT_NAME-$OWNER"

                  for svc in detector predictor rca simulator; do
                    REPO="$PREFIX-$svc"
                    IMAGE="$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$REPO:latest"

                    echo "==> Building $svc -> $REPO"
                    docker build -t "$REPO:latest" "./services/$svc"

                    echo "==> Tagging $REPO -> $IMAGE"
                    docker tag "$REPO:latest" "$IMAGE"

                    echo "==> Pushing $IMAGE"
                    docker push "$IMAGE"
                  done

    terraform-apply:
        runs-on: ubuntu-latest
        needs: terraform-plan
        if: github.event_name == 'workflow_dispatch' # solo manual

        steps:
            - uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
                  aws-session-token: ${{ env.AWS_SESSION_TOKEN }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3

            - name: Terraform Init
              working-directory: infrastructure/terraform
              run: terraform init

            - name: Terraform Apply
              working-directory: infrastructure/terraform
              run: terraform apply -auto-approve
