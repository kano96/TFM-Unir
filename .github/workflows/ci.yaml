name: CI - Lint, Test & Build

on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]

jobs:
    build-test:
        runs-on: ubuntu-latest
        steps:
            # 1. Checkout del código
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Configurar Python
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            # 3. Instalar dependencias
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
                  pip install flake8 pytest

            # 4. Lint (verifica estilo de código)
            - name: Run lint
              run: |
                  echo "Running flake8 lint..."
                  flake8 . --max-line-length=100 --exclude=.venv,venv,__pycache__,build,dist

            # 5. Tests (usa pytest)
            - name: Run tests
              run: |
                  echo "Running tests..."
                  pytest --maxfail=1 --disable-warnings -q

            # 6. Construir imagen Docker
            - name: Build Docker image
              run: |
                  echo "Building Docker image..."
                  docker build -t aiops-platform:latest .
